<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Mr Messi : AI No restrictions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="glass-container">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
        <header class="header">
            <div class="logo">
                <h1>Mr Messi : <span>AI No restrictions</span></h1>
            </div>
            <div class="user-menu">
                {% if current_user.is_authenticated %}
                <span class="user-name">{{ current_user.username }}</span>
                <a href="{{ url_for('profile') }}" class="tool-btn">
                    <i class="fas fa-user"></i>
                </a>
                <a href="{{ url_for('logout') }}" class="tool-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
                {% endif %}
            </div>
        </header>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="chat-main">
            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø§Ù„Ø£ÙŠØ³Ø± - Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
            <aside class="sidebar">
                <div class="user-card">
                    <div class="user-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="user-name">{{ current_user.username }}</div>
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ conversations|length }}</div>
                            <div class="stat-label">Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ current_user.total_questions }}</div>
                            <div class="stat-label">Ø³Ø¤Ø§Ù„</div>
                        </div>
                    </div>
                </div>

                <button class="tool-btn" id="newChatBtn" style="width: 100%; margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>

                <div class="conversations-list">
                    {% for conv in conversations %}
                    <div class="conversation-item" data-id="{{ conv.id }}">
                        <i class="fas fa-comment"></i>
                        <span>{{ conv.title }}</span>
                    </div>
                    {% endfor %}
                </div>
            </aside>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <main class="chat-area">
                <div class="chat-messages" id="messagesArea">
                    <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
                    <div class="message ai-message">
                        <div class="message-content">
                            <strong>Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ current_user.username }}! ğŸ‘‹</strong>
                            <p>Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø­Ø± Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©ØŒ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØŒ Ø£Ùˆ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø¢Ø®Ø±. Ø¹Ù†Ø¯Ùƒ {{ current_user.daily_questions }} Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ….</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
                    <div class="input-tools">
                        <label for="fileInput" class="tool-btn">
                            <i class="fas fa-paperclip"></i> Ø±ÙØ¹ Ù…Ù„Ù
                        </label>
                        <input type="file" id="fileInput" style="display: none;" accept=".txt,.pdf,.jpg,.jpeg,.png">
                        
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <i class="fas fa-file"></i>
                            <span id="fileName"></span>
                            <button onclick="clearFile()"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
                    <div class="input-wrapper">
                        <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
                        <button id="sendBtn">
                            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                        </button>
                    </div>
                </div>
            </main>

            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø§Ù„Ø£ÙŠÙ…Ù† - Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <aside class="right-sidebar">
                <div class="counter-card">
                    <div class="counter-number" id="remainingCount">{{ current_user.daily_questions }}</div>
                    <div class="counter-label">Ø³Ø¤Ø§Ù„ Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>

                <div class="info-card">
                    <h3><i class="fas fa-shield-alt"></i> Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯</h3>
                    <p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø§ ÙŠØ®Ø¶Ø¹ Ù„Ø£ÙŠ Ø±Ù‚Ø§Ø¨Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø¤Ø§Ù„Ù‡ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡</p>
                </div>

                <div class="info-card">
                    <h3><i class="fas fa-code"></i> Ø¯Ø¹Ù… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h3>
                    <p>ÙŠØªÙ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø²Ø± Ù†Ø³Ø®</p>
                </div>

                <div class="info-card">
                    <h3><i class="fas fa-file-alt"></i> Ø¯Ø¹Ù… Ø§Ù„Ù…Ù„ÙØ§Øª</h3>
                    <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±ØŒ PDFØŒ Ø£Ùˆ Ù…Ù„ÙØ§Øª Ù†ØµÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§</p>
                </div>
            </aside>
        </div>

        <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
        <footer class="footer">
            <p>Ù…Ø¨Ø±Ù…Ø¬ Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ©: <a href="https://t.me/messi123459" target="_blank">@messi123459</a></p>
        </footer>
    </div>

    <!-- ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
    <script>
        const messagesArea = document.getElementById('messagesArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const remainingSpan = document.getElementById('remainingCount');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        
        let currentFile = null;
        let currentConversationId = null;

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
        document.getElementById('newChatBtn')?.addEventListener('click', async () => {
            const response = await fetch('/api/new_conversation', {
                method: 'POST'
            });
            const data = await response.json();
            currentConversationId = data.id;
            messagesArea.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
            addMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ø³Ø£Ù„Ù†ÙŠ Ù…Ø§ ØªØ´Ø§Ø¡!', false);
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                fileName.textContent = file.name;
                fileInfo.style.display = 'flex';
            }
        });

        window.clearFile = () => {
            fileInput.value = '';
            currentFile = null;
            fileInfo.style.display = 'none';
        };

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        function addMessage(text, isUser = false, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (!isUser && !isError) {
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
                let formattedText = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre><code class="language-${lang || 'plaintext'}">${escapeHtml(code.trim())}</code></pre>`;
                });
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø³Ø·Ø± Ø¨ÙÙˆØ§ØµÙ„)
                formattedText = formattedText.replace(/\n/g, '<br>');
                
                contentDiv.innerHTML = formattedText;
                
                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù†Ø³Ø® Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒÙˆØ§Ø¯
                if (text.includes('```')) {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.innerHTML = '<i class="far fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯';
                    copyBtn.onclick = () => {
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø·
                        const codeMatch = text.match(/```(?:\w+)?\n([\s\S]*?)```/);
                        if (codeMatch) {
                            navigator.clipboard.writeText(codeMatch[1].trim()).then(() => {
                                copyBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
                                copyBtn.classList.add('copied');
                                setTimeout(() => {
                                    copyBtn.innerHTML = '<i class="far fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯';
                                    copyBtn.classList.remove('copied');
                                }, 2000);
                            });
                        }
                    };
                    messageDiv.appendChild(contentDiv);
                    messageDiv.appendChild(copyBtn);
                } else {
                    messageDiv.appendChild(contentDiv);
                }
            } else {
                contentDiv.textContent = text;
                messageDiv.appendChild(contentDiv);
            }
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ±Ù…ÙŠØ² HTML Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù‚Ù†
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„
        async function sendQuestion() {
            const question = userInput.value.trim();
            if (!question && !currentFile) return;

            // Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (question) {
                addMessage(question, true);
            }
            if (currentFile) {
                addMessage(`[ØªÙ… Ø±ÙØ¹ Ù…Ù„Ù: ${currentFile.name}]`, true);
            }
            
            // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const formData = new FormData();
            if (question) formData.append('prompt', question);
            if (currentFile) formData.append('file', currentFile);
            if (currentConversationId) formData.append('conversation_id', currentConversationId);
            
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            userInput.value = '';
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...';
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(data.response, false);
                    remainingSpan.textContent = data.remaining;
                    currentConversationId = data.conversation_id;
                    clearFile(); // Ù…Ø³Ø­ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                } else {
                    addMessage(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£', false, true);
                }
            } catch (error) {
                addMessage('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', false, true);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„';
            }
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendBtn.addEventListener('click', sendQuestion);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendQuestion();
        });

        // ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', async () => {
                const convId = item.dataset.id;
                const response = await fetch(`/api/conversation/${convId}`);
                const data = await response.json();
                
                currentConversationId = data.id;
                messagesArea.innerHTML = '';
                
                data.messages.forEach(msg => {
                    addMessage(msg.content, msg.role === 'user');
                });
            });
        });
    </script>
</body>
</html>